<!-- templates/index.html - ИСПРАВЛЕННАЯ ВЕРСИЯ -->
{% extends 'layout.html' %}

{% block title %}Список заявок{% endblock %}

{% block content %}
    <h2>Заявки на ремонт</h2>
    
    {% if g.user['role'] in ['client', 'operator', 'admin'] %}
        <div class="mb-3">
            <a href="{{ url_for('create_request') }}" class="btn btn-success">Создать новую заявку</a>
        </div>
    {% endif %}
    
    <table class="requests-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Дата</th>
                <th>Оборудование</th>
                <th>Проблема</th>
                {% if g.user['role'] != 'client' %}
                    <th>Клиент</th>
                {% endif %}
                <th>Статус</th>
                <th>Мастер</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for request_item in requests %}
            <tr>
                <td>{{ request_item['id'] }}</td>
                <td>{{ request_item['created_date'][:10] if request_item['created_date'] else '' }}</td>
                <td>{{ request_item['equipment_type'] }}<br>{{ request_item['equipment_model'] }}</td>
                <td>{{ request_item['problem_description'][:50] }}...</td>
                {% if g.user['role'] != 'client' %}
                    <td>{{ request_item['client_fio'] or 'Неизвестно' }}</td>
                {% endif %}
                <td>
                    <span class="status status-{{ request_item['status'] }}">
                        {% if request_item['status'] == 'new' %}Новая
                        {% elif request_item['status'] == 'in_progress' %}В работе
                        {% elif request_item['status'] == 'waiting_parts' %}Ожидание запчастей
                        {% elif request_item['status'] == 'completed' %}Завершена
                        {% elif request_item['status'] == 'cancelled' %}Отменена
                        {% else %}{{ request_item['status'] }}{% endif %}
                    </span>
                </td>
                <td>{{ request_item['specialist_fio'] or 'Не назначен' }}</td>
                <td>
                    <a href="{{ url_for('request_detail', request_id=request_item['id']) }}" class="btn-small">Подробнее</a>
                    
                    <!-- Быстрое назначение мастера для операторов/админов -->
                    {% if g.user['role'] in ['operator', 'admin', 'manager'] and request_item['status'] == 'new' %}
                    <form method="post" action="{{ url_for('assign_master', request_id=request_item['id']) }}" class="inline-form-small">
                        <input type="hidden" name="master_id" value="2">
                        <button type="submit" class="btn-small btn-success">Назначить</button>
                    </form>
                    {% endif %}
                    
                    <!-- Быстрое взятие в работу для специалистов -->
                    {% if g.user['role'] == 'specialist' and not request_item['assigned_specialist_id'] and request_item['status'] == 'new' %}
                    <form method="post" action="{{ url_for('take_request', request_id=request_item['id']) }}" class="inline-form-small">
                        <button type="submit" class="btn-small btn-warning">Взять</button>
                    </form>
                    {% endif %}
                    
                    <!-- Кнопка редактирования -->
                    {% if g.user['role'] in ['operator', 'specialist', 'admin', 'manager'] %}
                        <a href="{{ url_for('edit_request', request_id=request_item['id']) }}" class="btn-small btn-edit">Изменить</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if not requests %}
        <p class="text-muted">Нет заявок для отображения.</p>
    {% endif %}
{% endblock %}